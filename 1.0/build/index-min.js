/*! TimeLines - v1.0 - 2013-09-23 8:55:56 PM
* Copyright (c) 2013 jixiangac; Licensed  */
KISSY.add("gallery/TimeLines/1.0/index",function(a,b,c,d){"use strict";function e(a){var b=this;e.superclass.constructor.call(b,a),b.init()}var f=a.DOM,g=a.Event;return a.all,a.extend(e,a.Base),a.augment(e,{init:function(){var a=this;a.el=a.get("container"),f.css(a.el,{position:"relative","padding-top":"10px"}),a.curdate=a.get("curDate")||null;var b=(new Date).getFullYear();a.hashYear={},a.hashYear[b]=!0,a.outerw=f.outerWidth(a.el),a.today=a.get("today")||a.formatDate(new Date,"yyyy-MM-dd"),a.isReToday=a.today===a.curdate,a._initDateGrid(a.get("data"))},_initDateGrid:function(b){var c=this;try{if(!c._typeof(b,"Array")){var d=new Error;throw d.name="\u7c7b\u578b\u51fa\u9519",d.message="\u4f20\u5165\u7684data\u4e0d\u662f\u6570\u7ec4!",d}var e=c._initTimeNode("wrap",{end:!0});e+=c._initTimeNode("line",{num:3}),c._getTimeMs(c.today)<c._getTimeMs(b[0].date)&&(e=c._addmission(e,{before:null,after:b[0].date})),a.each(b,function(a,d){if(c._isSameYear(a.date)||(e+=c._initTimeNode("dot",{time:c.formatDate(a.date,"yyyy")})),0!==d||c.today!==a.date){var f=c.curdate&&a.date==c.curdate;if(c.today!==a.date||f){var g=f?"cur":"node";e+=c._initTimeNode(g,{time:c.formatDate(a.date,"MM.dd")})}}c.today===a.date&&(c.isReToday=!0),e=c._addmission(e,{before:a.date,after:b[d+1]&&b[d+1].date})}),c.outerw>0&&(e+=c._initTimeNode("line",{num:Math.ceil(c.outerw/16)})),f.append(f.create(e+"</div></div>"),c.el),c.elwrap=f.get(".timeline-wrap",c.el),c._initNodeEvents(b)}catch(g){console.log(g.message)}},_initTimeNode:function(a,b){var c=this,d={wrap:'<div class="timeline-wrap"><div class="timeline-main">',node:'<div class="timeline-node">',line:'<div class="timeline-line">',omission:'<div class="timeline-omission">',shine:'<div class="timeline-node timeline-blue-node">',cur:'<div class="timeline-cur-left"></div><div class="timeline-node timeline-cur">',dot:'<div class="timeline-dot">'},e={node:40,line:16,omission:20,shine:40,cur:120,dot:33};if("wrap"!==a){var f=b&&b.num||1;c.outerw-=e[a]*f}var g=d[a];if(b&&b.time&&(g+="<a>"+b.time+"</a>"),b&&b.end)return g;if("cur"===a&&(g+='</div><div class="timeline-cur-right">'),b&&b.num){g+="</div>";for(var h=0;h<b.num;h++)g+=d[a]+"</div>",c.outerw-=e[a];return g}return g+"</div>"},_addToady:function(a){var b=this;return b.curdate&&b.today!=b.curdate?a+b._initTimeNode("shine",{time:b.formatDate(b.today,"MM.dd")}):a},_addmission:function(a,b){function c(b,c){var d=(c-b)/864e5,e=Math.floor(d/30);switch(e=e>2?2:e,!0){case d>2&&6>d:return a+=f._initTimeNode("dot");case d>6:return a+=f._initTimeNode("omission",{num:e});default:return a}}var d,e,f=this,g=f._getTimeMs(f.today);return!b.before&&b.after?(e=f._getTimeMs(b.after),a=f._addToady(a),a=c(g,e)):(d=f._getTimeMs(b.before),b.after?(e=f._getTimeMs(b.after),g>=d&&e>g?(g!==d&&(a=c(d,g)),a=f._addToady(a),g!==e&&(a=c(g,e))):a=c(d,e),a):(g>d&&(a=c(d,g),a=f._addToady(a)),a))},_getTimeMs:function(a){return new Date(a).getTime()},_typeof:function(a,b){return Object.prototype.toString.call(a)==="[object "+b+"]"},_isSameYear:function(a){var b=this,c=new Date(a).getFullYear();return b.hashYear[c]?!0:(b.hashYear[c]=!0,!1)},_initNodeEvents:function(b){function c(){d.tipsInter=setTimeout(function(){d._tipIndex=d._tipIndex>d._tipQueue.length-1?0:d._tipIndex,d._initTips(d._tipQueue[d._tipIndex++]),c()},1500)}var d=this,e=f.query(".timeline-node",d.el);a.each(e,function(a,b){!d.isReToday&&f.hasClass(a,"timeline-blue-node")&&(f.css(a,{cursor:"default"}),e.splice(b,1))});var h=f.offset(d.elwrap).left,i=[],j={};a.each(e,function(a,c){var e=b[c],k=f.offset(a).left;e.left=k-h+Math.ceil(f.outerWidth(a)/2);var l,m=d._typeof(e.tip,"Array");if(m){for(var n=0,o=e.tip.length;o>n;n++)l={left:e.left,date:e.date,tip:e.tip[n]},i.push(l);j[c]=o}else i.push(e),j[c]=1;var p,q,r;g.on(a,"mouseover",function(){d.anim&&d.anim.stop(),q=m?Math.floor(Math.random()*e.tip.length):0,r=0;for(var a=0;c>a;a++)r+=j[a];d._tipIndex=r+q,p=m?{left:e.left,date:e.date,tip:e.tip[q]}:e,d._initTips(p)})}),g.on(d.elwrap,"mouseover mouseout",function(a){switch(a.type){case"mouseover":d.anim&&d.anim.stop(!0),clearTimeout(d.tipsInter);break;case"mouseout":c()}}),d._tipQueue=i,d._tipIndex=0,d.tipsInter=null,c()},_initTips:function(a){var b=this,c={left:a.left,tip:b._typeof(a.tip,"Array")?a.tip[0]:a.tip};if(b._tips,b._tips)f.get("span",b._tips).innerHTML=c.tip,b.anim&&b.anim.stop(),a.date===b.curdate?f.addClass(b._tips,"tip-cur"):f.removeClass(b._tips,"tip-cur"),b.anim=new d(b._tips,{left:c.left,marginLeft:-f.outerWidth(b._tips)/2},.5,"easeBoth",!1,function(){}).run();else{var e='<div class="tip" style="left:'+c.left+'px">'+'<div class="arrow-grey"><div class="arrow"></div></div>'+"<span>"+c.tip+"</span>"+"</div>";b._tips=f.create(e),a.date===b.curdate?f.addClass(b._tips,"tip-cur"):f.removeClass(b._tips,"tip-cur"),f.append(b._tips,b.el),f.css(b._tips,{"margin-left":-f.outerWidth(b._tips)/2})}},formatDate:function(a,b){var c=new Date(a),d={"M+":c.getMonth()+1,"d+":c.getDate(),"h+":c.getHours(),"m+":c.getMinutes(),"s+":c.getSeconds(),"q+":Math.floor((c.getMonth()+3)/3),S:c.getMilliseconds()};/(y+)/.test(b)&&(b=b.replace(RegExp.$1,(c.getFullYear()+"").substr(4-RegExp.$1.length)));for(var e in d)new RegExp("("+e+")").test(b)&&(b=b.replace(RegExp.$1,1==RegExp.$1.length?d[e]:("00"+d[e]).substr((""+d[e]).length)));return b}}),e},{requires:["node","base","anim","./timeline.css"]});